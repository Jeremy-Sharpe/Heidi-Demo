<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADIME Report</title>
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --light-gray: #f5f7f9;
            --border-radius: 4px;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        body {
            font-family: Arial, sans-serif;
            line-height: 1.5;
            color: #333;
            background-color: var(--light-gray);
            margin: 0;
            padding: 20px;
            font-size: 11pt;
        }
        
        .container {
            max-width: 1000px;
            margin: 20px auto;
            background-color: white;
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--shadow);
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .header-content {
            flex: 1;
        }
        
        .patient-info {
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .patient-info p {
            margin: 5px 0;
        }
        
        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: var(--secondary-color);
        }
        
        .btn-secondary {
            background-color: #7f8c8d;
        }
        
        .btn-secondary:hover {
            background-color: #6a7778;
        }
        
        .section {
            margin-bottom: 30px;
            clear: both;
            position: relative;
        }
        
        .section-title {
            color: var(--primary-color);
            font-size: 16pt;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .editor {
            border: none;
            padding: 0;
            min-height: 0;
            margin-bottom: 15px;
        }
        
        .data-row {
            margin-bottom: 5px;
            position: relative;
        }
        
        .data-label {
            font-weight: bold;
            display: inline-block;
            min-width: 200px;
        }
        
        .subsection {
            margin-top: 15px;
            margin-bottom: 15px;
            position: relative;
        }
        
        .subsection-title {
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .hidden {
            display: none;
        }
        
        .add-field-btn {
            background-color: #2ecc71;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 16px;
            line-height: 24px;
            text-align: center;
            cursor: pointer;
            margin-left: 10px;
            display: inline-block;
        }
        
        .remove-field-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            line-height: 20px;
            text-align: center;
            cursor: pointer;
            position: absolute;
            right: 0;
            top: 5px;
            display: none;
        }
        
        .data-row:hover .remove-field-btn {
            display: block;
        }
        
        .add-subsection-btn {
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 5px 10px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 10px;
            display: inline-block;
        }
        
        .add-section-btn {
            background-color: #9b59b6;
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 8px 15px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 20px;
            display: inline-block;
        }
        
        .section-actions {
            margin-bottom: 15px;
        }
        
        .custom-field-input {
            width: 180px;
            padding: 5px;
            margin-right: 10px;
        }
        
        /* Handle in print view */
        @media print {
            body {
                background-color: white;
                padding: 0;
            }
            
            .container {
                box-shadow: none;
                max-width: 100%;
                padding: 15px;
            }
            
            .actions, .ql-toolbar, .add-field-btn, .remove-field-btn, .add-subsection-btn, .add-section-btn, .section-actions {
                display: none !important;
            }
            
            .section {
                break-inside: avoid;
                page-break-inside: avoid;
            }
            
            .editor, .ql-editor {
                max-height: none;
                overflow: visible;
            }
        }
        
        ul, ol {
            margin-top: 5px;
            margin-bottom: 5px;
            padding-left: 20px;
        }
        
        /* Set page margins */
        @page {
            margin: 1cm 1.5cm;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1 style="margin-top: 0; margin-bottom: 15px;">ADIME Report</h1>
                
                <div class="patient-info">
                    <p><span class="data-label">Resident Name:</span> 
                        <span id="resident-name" class="editor">
                            {% if adime_data.patient_info and adime_data.patient_info.name %}
                            {{ adime_data.patient_info.name }}
                            {% else %}
                            Unknown
                            {% endif %}
                        </span>
                    </p>
                    <p><span class="data-label">Date:</span> 
                        <span id="report-date" class="editor">
                            {% if adime_data.patient_info and adime_data.patient_info.date %}
                            {{ adime_data.patient_info.date }}
                            {% else %}
                            {{ now.strftime('%d %B %Y') }}
                            {% endif %}
                        </span>
                    </p>
                    <p><span class="data-label">Time:</span> 
                        <span id="report-time" class="editor">
                            {% if adime_data.patient_info and adime_data.patient_info.time %}
                            {{ adime_data.patient_info.time }}
                            {% else %}
                            {{ now.strftime('%H:%M %p') }}
                            {% endif %}
                        </span>
                    </p>
                    <p><span class="data-label">RD Name:</span> 
                        <span id="rd-name" class="editor">
                            {% if adime_data.patient_info and adime_data.patient_info.rd_name %}
                            {{ adime_data.patient_info.rd_name }}
                            {% else %}
                            
                            {% endif %}
                        </span>
                    </p>
                    <div class="custom-fields-patient"></div>
                    <div class="add-field-container">
                        <button class="add-field-btn" title="Add new field" onclick="addCustomField('patient-info', '.custom-fields-patient')">+</button>
                    </div>
                </div>
            </div>
            
            <div class="actions">
                <button id="edit-toggle-btn" class="btn btn-secondary">Exit Edit Mode</button>
                <button id="generate-pdf-btn" class="btn">Download PDF</button>
            </div>
        </div>
        
        <div id="editor-container">
            <!-- Assessment Section -->
            <div id="assessment-section" class="section">
                <h2 class="section-title">(A) Assessment:</h2>
                
                <!-- Patient Demographics -->
                <div class="subsection">
                    <p class="data-row"><span class="data-label">Age:</span> 
                        <span id="patient-age" class="editor">
                            {% if adime_data.assessment.age %}{{ adime_data.assessment.age }}{% endif %}
                        </span>
                        <button class="remove-field-btn" title="Remove field" onclick="removeField(this.parentElement)">Ã—</button>
                    </p>
                    <p class="data-row"><span class="data-label">Gender:</span> 
                        <span id="patient-gender" class="editor">
                            {% if adime_data.assessment.gender %}{{ adime_data.assessment.gender }}{% endif %}
                        </span>
                        <button class="remove-field-btn" title="Remove field" onclick="removeField(this.parentElement)">Ã—</button>
                    </p>
                    <p class="data-row"><span class="data-label">Weight:</span> 
                        <span id="patient-weight" class="editor">
                            {% if adime_data.assessment.weight %}{{ adime_data.assessment.weight }}{% endif %}
                        </span>
                        <button class="remove-field-btn" title="Remove field" onclick="removeField(this.parentElement)">Ã—</button>
                    </p>
                    <p class="data-row"><span class="data-label">Height:</span> 
                        <span id="patient-height" class="editor">
                            {% if adime_data.assessment.height %}{{ adime_data.assessment.height }}{% endif %}
                        </span>
                        <button class="remove-field-btn" title="Remove field" onclick="removeField(this.parentElement)">Ã—</button>
                    </p>
                    <p class="data-row"><span class="data-label">Body Mass Index (BMI):</span> 
                        <span id="patient-bmi" class="editor">
                            {% if adime_data.assessment.bmi %}{{ adime_data.assessment.bmi }}{% endif %}
                        </span>
                        <button class="remove-field-btn" title="Remove field" onclick="removeField(this.parentElement)">Ã—</button>
                    </p>
                    <p class="data-row"><span class="data-label">Usual Body Weight (UBW):</span> 
                        <span id="patient-ubw" class="editor">
                            {% if adime_data.assessment.ubw %}{{ adime_data.assessment.ubw }}{% endif %}
                        </span>
                        <button class="remove-field-btn" title="Remove field" onclick="removeField(this.parentElement)">Ã—</button>
                    </p>
                    <p class="data-row"><span class="data-label">Weight History:</span> 
                        <span id="weight-history" class="editor">
                            {% if adime_data.assessment.weight_history %}{{ adime_data.assessment.weight_history }}{% endif %}
                        </span>
                        <button class="remove-field-btn" title="Remove field" onclick="removeField(this.parentElement)">Ã—</button>
                    </p>
                    <p class="data-row"><span class="data-label">IBW/%IBW:</span> 
                        <span id="patient-ibw" class="editor">
                            {% if adime_data.assessment.ibw %}{{ adime_data.assessment.ibw }}{% endif %}
                        </span>
                        <button class="remove-field-btn" title="Remove field" onclick="removeField(this.parentElement)">Ã—</button>
                    </p>
                    
                    <div class="custom-fields-demographics"></div>
                    <div class="add-field-container">
                        <button class="add-field-btn" title="Add new field" onclick="addCustomField('demographics', '.custom-fields-demographics')">+</button>
                    </div>
                </div>
                
                <!-- Dietary Information -->
                <div class="subsection">
                    <div class="subsection-title">Dietary Information</div>
                    <p class="data-row"><span class="data-label">Appetite:</span> 
                        <span id="patient-appetite" class="editor">
                            {% if adime_data.assessment.appetite %}{{ adime_data.assessment.appetite }}{% endif %}
                        </span>
                        <button class="remove-field-btn" title="Remove field" onclick="removeField(this.parentElement)">Ã—</button>
                    </p>
                    <p class="data-row"><span class="data-label">Food Allergies/Intolerance:</span> 
                        <span id="food-allergies" class="editor">
                            {% if adime_data.assessment.food_allergies %}{{ adime_data.assessment.food_allergies }}{% endif %}
                        </span>
                        <button class="remove-field-btn" title="Remove field" onclick="removeField(this.parentElement)">Ã—</button>
                    </p>
                    <p class="data-row"><span class="data-label">Food Preferences:</span> 
                        <span id="food-preferences" class="editor">
                            {% if adime_data.assessment.food_preferences %}{{ adime_data.assessment.food_preferences }}{% endif %}
                        </span>
                        <button class="remove-field-btn" title="Remove field" onclick="removeField(this.parentElement)">Ã—</button>
                    </p>
                    <p class="data-row"><span class="data-label">Adaptive Devices:</span> 
                        <span id="adaptive-devices" class="editor">
                            {% if adime_data.assessment.adaptive_devices %}{{ adime_data.assessment.adaptive_devices }}{% endif %}
                        </span>
                        <button class="remove-field-btn" title="Remove field" onclick="removeField(this.parentElement)">Ã—</button>
                    </p>
                    
                    <div class="custom-fields-dietary"></div>
                    <div class="add-field-container">
                        <button class="add-field-btn" title="Add new field" onclick="addCustomField('dietary', '.custom-fields-dietary')">+</button>
                    </div>
                </div>
                
                <!-- Diet Information -->
                <div class="subsection">
                    <p class="data-row"><span class="data-label">Current diet order:</span> 
                        <span id="diet-order" class="editor">
                            {% if adime_data.assessment.diet_order %}{{ adime_data.assessment.diet_order }}{% endif %}
                        </span>
                        <button class="remove-field-btn" title="Remove field" onclick="removeField(this.parentElement)">Ã—</button>
                    </p>
                    <p class="data-row"><span class="data-label">% intake of meals:</span> 
                        <span id="meal-intake" class="editor">
                            {% if adime_data.assessment.meal_intake_percent %}{{ adime_data.assessment.meal_intake_percent }}{% endif %}
                        </span>
                        <button class="remove-field-btn" title="Remove field" onclick="removeField(this.parentElement)">Ã—</button>
                    </p>
                    <p class="data-row"><span class="data-label">Supplement order:</span> 
                        <span id="supplement-order" class="editor">
                            {% if adime_data.assessment.supplement_order %}{{ adime_data.assessment.supplement_order }}{% endif %}
                        </span>
                        <button class="remove-field-btn" title="Remove field" onclick="removeField(this.parentElement)">Ã—</button>
                    </p>
                    <p class="data-row"><span class="data-label">% intake of supplement:</span> 
                        <span id="supplement-intake" class="editor">
                            {% if adime_data.assessment.supplement_intake_percent %}{{ adime_data.assessment.supplement_intake_percent }}{% endif %}
                        </span>
                        <button class="remove-field-btn" title="Remove field" onclick="removeField(this.parentElement)">Ã—</button>
                    </p>
                    <p class="data-row"><span class="data-label">Chewing or swallowing difficulty:</span> 
                        <span id="chewing-swallowing" class="editor">
                            {% if adime_data.assessment.chewing_swallowing %}{{ adime_data.assessment.chewing_swallowing }}{% endif %}
                        </span>
                        <button class="remove-field-btn" title="Remove field" onclick="removeField(this.parentElement)">Ã—</button>
                    </p>
                    
                    <div class="custom-fields-diet"></div>
                    <div class="add-field-container">
                        <button class="add-field-btn" title="Add new field" onclick="addCustomField('diet', '.custom-fields-diet')">+</button>
                    </div>
                </div>
                
                <!-- Medical Information -->
                <div class="subsection">
                    <p class="data-row"><span class="data-label">Feeding Assistance:</span> 
                        <span id="feeding-assistance" class="editor">
                            {% if adime_data.assessment.feeding_assistance %}{{ adime_data.assessment.feeding_assistance }}{% endif %}
                        </span>
                        <button class="remove-field-btn" title="Remove field" onclick="removeField(this.parentElement)">Ã—</button>
                    </p>
                    <p class="data-row"><span class="data-label">Skin condition:</span> 
                        <span id="skin-condition" class="editor">
                            {% if adime_data.assessment.skin_condition %}{{ adime_data.assessment.skin_condition }}{% endif %}
                        </span>
                        <button class="remove-field-btn" title="Remove field" onclick="removeField(this.parentElement)">Ã—</button>
                    </p>
                    <p class="data-row"><span class="data-label">Medical diagnosis:</span> 
                        <span id="medical-diagnosis" class="editor">
                            {% if adime_data.assessment.medical_diagnosis %}{{ adime_data.assessment.medical_diagnosis }}{% endif %}
                        </span>
                        <button class="remove-field-btn" title="Remove field" onclick="removeField(this.parentElement)">Ã—</button>
                    </p>
                    <p class="data-row"><span class="data-label">Pertinent labs:</span> 
                        <span id="pertinent-labs" class="editor">
                            {% if adime_data.assessment.labs %}
                                {% if adime_data.assessment.labs is string %}
                                    {{ adime_data.assessment.labs }}
                                {% else %}
                                    {% for lab in adime_data.assessment.labs %}
                                        {{ lab }}{% if not loop.last %}, {% endif %}
                                    {% endfor %}
                                {% endif %}
                            {% endif %}
                        </span>
                        <button class="remove-field-btn" title="Remove field" onclick="removeField(this.parentElement)">Ã—</button>
                    </p>
                    <p class="data-row"><span class="data-label">Pertinent medications:</span> 
                        <span id="pertinent-medications" class="editor">
                            {% if adime_data.assessment.medications %}{{ adime_data.assessment.medications }}{% endif %}
                        </span>
                        <button class="remove-field-btn" title="Remove field" onclick="removeField(this.parentElement)">Ã—</button>
                    </p>
                    
                    <div class="custom-fields-medical"></div>
                    <div class="add-field-container">
                        <button class="add-field-btn" title="Add new field" onclick="addCustomField('medical', '.custom-fields-medical')">+</button>
                    </div>
                </div>
                
                <!-- NFPE Section -->
                <div class="subsection">
                    <div class="subsection-title">Nutritional Focused Physical Exam (NFPE):</div>
                    <p class="data-row"><span class="data-label">Appearance:</span> 
                        <span id="nfpe-appearance" class="editor">
                            {% if adime_data.assessment.nfpe_appearance %}{{ adime_data.assessment.nfpe_appearance }}{% endif %}
                        </span>
                        <button class="remove-field-btn" title="Remove field" onclick="removeField(this.parentElement)">Ã—</button>
                    </p>
                    <p class="data-row"><span class="data-label">Body Fat:</span> 
                        <span id="nfpe-body-fat" class="editor">
                            {% if adime_data.assessment.nfpe_body_fat %}{{ adime_data.assessment.nfpe_body_fat }}{% endif %}
                        </span>
                        <button class="remove-field-btn" title="Remove field" onclick="removeField(this.parentElement)">Ã—</button>
                    </p>
                    <p class="data-row"><span class="data-label">Orbital:</span> 
                        <span id="nfpe-orbital" class="editor">
                            {% if adime_data.assessment.nfpe_orbital %}{{ adime_data.assessment.nfpe_orbital }}{% endif %}
                        </span>
                        <button class="remove-field-btn" title="Remove field" onclick="removeField(this.parentElement)">Ã—</button>
                    </p>
                    <p class="data-row"><span class="data-label">Triceps:</span> 
                        <span id="nfpe-triceps" class="editor">
                            {% if adime_data.assessment.nfpe_triceps %}{{ adime_data.assessment.nfpe_triceps }}{% endif %}
                        </span>
                        <button class="remove-field-btn" title="Remove field" onclick="removeField(this.parentElement)">Ã—</button>
                    </p>
                    <p class="data-row"><span class="data-label">Fat overlying ribs:</span> 
                        <span id="nfpe-ribs-fat" class="editor">
                            {% if adime_data.assessment.nfpe_ribs_fat %}{{ adime_data.assessment.nfpe_ribs_fat }}{% endif %}
                        </span>
                        <button class="remove-field-btn" title="Remove field" onclick="removeField(this.parentElement)">Ã—</button>
                    </p>
                    
                    <div class="custom-fields-nfpe"></div>
                    <div class="add-field-container">
                        <button class="add-field-btn" title="Add new field" onclick="addCustomField('nfpe', '.custom-fields-nfpe')">+</button>
                    </div>
                </div>
                
                <!-- Muscle Mass -->
                <div class="subsection">
                    <div class="subsection-title">Muscle Mass:</div>
                    <p class="data-row"><span class="data-label">Temple:</span> 
                        <span id="muscle-temple" class="editor">
                            {% if adime_data.assessment.muscle_temple %}{{ adime_data.assessment.muscle_temple }}{% endif %}
                        </span>
                        <button class="remove-field-btn" title="Remove field" onclick="removeField(this.parentElement)">Ã—</button>
                    </p>
                    <p class="data-row"><span class="data-label">Pectoralis:</span> 
                        <span id="muscle-pectoralis" class="editor">
                            {% if adime_data.assessment.muscle_pectoralis %}{{ adime_data.assessment.muscle_pectoralis }}{% endif %}
                        </span>
                        <button class="remove-field-btn" title="Remove field" onclick="removeField(this.parentElement)">Ã—</button>
                    </p>
                    <p class="data-row"><span class="data-label">Delt:</span> 
                        <span id="muscle-delt" class="editor">
                            {% if adime_data.assessment.muscle_delt %}{{ adime_data.assessment.muscle_delt }}{% endif %}
                        </span>
                        <button class="remove-field-btn" title="Remove field" onclick="removeField(this.parentElement)">Ã—</button>
                    </p>
                    <p class="data-row"><span class="data-label">Hand:</span> 
                        <span id="muscle-hand" class="editor">
                            {% if adime_data.assessment.muscle_hand %}{{ adime_data.assessment.muscle_hand }}{% endif %}
                        </span>
                        <button class="remove-field-btn" title="Remove field" onclick="removeField(this.parentElement)">Ã—</button>
                    </p>
                    <p class="data-row"><span class="data-label">Back:</span> 
                        <span id="muscle-back" class="editor">
                            {% if adime_data.assessment.muscle_back %}{{ adime_data.assessment.muscle_back }}{% endif %}
                        </span>
                        <button class="remove-field-btn" title="Remove field" onclick="removeField(this.parentElement)">Ã—</button>
                    </p>
                    <p class="data-row"><span class="data-label">Thigh:</span> 
                        <span id="muscle-thigh" class="editor">
                            {% if adime_data.assessment.muscle_thigh %}{{ adime_data.assessment.muscle_thigh }}{% endif %}
                        </span>
                        <button class="remove-field-btn" title="Remove field" onclick="removeField(this.parentElement)">Ã—</button>
                    </p>
                    
                    <div class="custom-fields-muscle"></div>
                    <div class="add-field-container">
                        <button class="add-field-btn" title="Add new field" onclick="addCustomField('muscle', '.custom-fields-muscle')">+</button>
                    </div>
                </div>
                
                <!-- Hydration and Malnutrition -->
                <div class="subsection">
                    <p class="data-row"><span class="data-label">Hydration Status:</span> 
                        <span id="hydration-status" class="editor">
                            {% if adime_data.assessment.hydration_status %}{{ adime_data.assessment.hydration_status }}{% endif %}
                        </span>
                        <button class="remove-field-btn" title="Remove field" onclick="removeField(this.parentElement)">Ã—</button>
                    </p>
                    <p class="data-row"><span class="data-label">Malnutrition Status:</span> 
                        <span id="malnutrition-status" class="editor">
                            {% if adime_data.assessment.malnutrition_status %}{{ adime_data.assessment.malnutrition_status }}{% endif %}
                        </span>
                        <button class="remove-field-btn" title="Remove field" onclick="removeField(this.parentElement)">Ã—</button>
                    </p>
                    
                    <div class="custom-fields-hydration"></div>
                    <div class="add-field-container">
                        <button class="add-field-btn" title="Add new field" onclick="addCustomField('hydration', '.custom-fields-hydration')">+</button>
                    </div>
                </div>
                
                <!-- Nutrition Needs -->
                <div class="subsection">
                    <div class="subsection-title">Daily Estimated Nutrition Needs:</div>
                    <p class="data-row"><span class="data-label">Total calories (kcal):</span> 
                        <span id="calories-needs" class="editor">
                            {% if adime_data.assessment.calories_needs %}{{ adime_data.assessment.calories_needs }}{% endif %}
                        </span>
                        <button class="remove-field-btn" title="Remove field" onclick="removeField(this.parentElement)">Ã—</button>
                    </p>
                    <p class="data-row"><span class="data-label">Total protein (g/kg):</span> 
                        <span id="protein-needs" class="editor">
                            {% if adime_data.assessment.protein_needs %}{{ adime_data.assessment.protein_needs }}{% endif %}
                        </span>
                        <button class="remove-field-btn" title="Remove field" onclick="removeField(this.parentElement)">Ã—</button>
                    </p>
                    <p class="data-row"><span class="data-label">Total fluids (ml):</span> 
                        <span id="fluid-needs" class="editor">
                            {% if adime_data.assessment.fluid_needs %}{{ adime_data.assessment.fluid_needs }}{% endif %}
                        </span>
                        <button class="remove-field-btn" title="Remove field" onclick="removeField(this.parentElement)">Ã—</button>
                    </p>
                    <p class="data-row"><span class="data-label">Does current meal and supplement intake meet estimated needs?</span> 
                        <span id="needs-met" class="editor">
                            {% if adime_data.assessment.needs_met %}{{ adime_data.assessment.needs_met }}{% endif %}
                        </span>
                        <button class="remove-field-btn" title="Remove field" onclick="removeField(this.parentElement)">Ã—</button>
                    </p>
                    
                    <div class="custom-fields-nutrition"></div>
                    <div class="add-field-container">
                        <button class="add-field-btn" title="Add new field" onclick="addCustomField('nutrition', '.custom-fields-nutrition')">+</button>
                    </div>
                </div>
                
                <!-- Custom subsections for Assessment -->
                <div id="custom-subsections-assessment"></div>
                <div class="section-actions">
                    <button class="add-subsection-btn" onclick="addCustomSubsection('assessment')">Add Subsection</button>
                </div>
            </div>
            
            <!-- Diagnosis Section -->
            <div id="diagnosis-section" class="section">
                <h2 class="section-title">(D) Nutrition Diagnosis:</h2>
                <div id="diagnosis-content" class="editor">
                    {% if adime_data.diagnosis.content %}
                    {{ adime_data.diagnosis.content }}
                    {% elif adime_data.diagnosis.summary %}
                    {{ adime_data.diagnosis.summary }}
                    {% elif adime_data.diagnosis is string %}
                    {{ adime_data.diagnosis }}
                    {% endif %}
                </div>
                
                <div class="subsection">
                    <div class="subsection-title">Nutrition goals (SMART):</div>
                    <div id="nutrition-goals" class="editor">
                        {% if adime_data.diagnosis.goals %}
                            {% if adime_data.diagnosis.goals is string %}
                                {{ adime_data.diagnosis.goals }}
                            {% else %}
                                <ul>
                                    {% for goal in adime_data.diagnosis.goals %}
                                    <li>{{ goal }}</li>
                                    {% endfor %}
                                </ul>
                            {% endif %}
                        {% elif adime_data.intervention.short_term_goals or adime_data.intervention.long_term_goals %}
                            <ul>
                                {% for goal in adime_data.intervention.short_term_goals %}
                                <li>{{ goal }}</li>
                                {% endfor %}
                                {% for goal in adime_data.intervention.long_term_goals %}
                                <li>{{ goal }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Custom subsections for Diagnosis -->
                <div id="custom-subsections-diagnosis"></div>
                <div class="section-actions">
                    <button class="add-subsection-btn" onclick="addCustomSubsection('diagnosis')">Add Subsection</button>
                </div>
            </div>
                
            <!-- Intervention Section -->
            <div id="intervention-section" class="section">
                <h2 class="section-title">(I) Nutrition Interventions/Recommendations:</h2>
                <div id="intervention-content" class="editor">
                    {% if adime_data.intervention.content %}
                    {{ adime_data.intervention.content }}
                    {% elif adime_data.intervention.summary %}
                    {{ adime_data.intervention.summary }}
                    {% elif adime_data.intervention is string %}
                    {{ adime_data.intervention }}
                    {% else %}
                    {% set action_items = [] %}
                    {% if adime_data.intervention.action_items is defined %}
                    {% set action_items = adime_data.intervention.action_items %}
                    {% elif adime_data.action_items is defined %}
                    {% set action_items = adime_data.action_items %}
                    {% endif %}
                    
                        <ul>
                    {% for item in action_items %}
                            <li>{{ item.description }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>
                
                <!-- Custom subsections for Intervention -->
                <div id="custom-subsections-intervention"></div>
                <div class="section-actions">
                    <button class="add-subsection-btn" onclick="addCustomSubsection('intervention')">Add Subsection</button>
                </div>
            </div>
            
            <!-- Monitoring Section -->
            <div id="monitoring-section" class="section">
                <h2 class="section-title">(M/E) Monitoring and Evaluation Plan:</h2>
                <div id="monitoring-content" class="editor">
                    {% if adime_data.monitoring.content %}
                    {{ adime_data.monitoring.content }}
                    {% elif adime_data.monitoring.summary %}
                    {{ adime_data.monitoring.summary }}
                    {% elif adime_data.monitoring is string %}
                    {{ adime_data.monitoring }}
                    {% else %}
                        {% if adime_data.monitoring.follow_up or adime_data.monitoring.metrics or adime_data.monitoring.timeline %}
                            <ul>
                                {% if adime_data.monitoring.follow_up %}
                                <li>{{ adime_data.monitoring.follow_up }}</li>
                                {% endif %}
                                
                                {% if adime_data.monitoring.metrics %}
                                    {% if adime_data.monitoring.metrics is string %}
                                    <li>{{ adime_data.monitoring.metrics }}</li>
                                    {% else %}
                                        {% for metric in adime_data.monitoring.metrics %}
                                        <li>{{ metric }}</li>
                                        {% endfor %}
                                    {% endif %}
                                {% endif %}
                                
                                {% if adime_data.monitoring.timeline %}
                                <li>{{ adime_data.monitoring.timeline }}</li>
                                {% endif %}
                            </ul>
                        {% endif %}
                    {% endif %}
                </div>
                
                <!-- Custom subsections for Monitoring -->
                <div id="custom-subsections-monitoring"></div>
                <div class="section-actions">
                    <button class="add-subsection-btn" onclick="addCustomSubsection('monitoring')">Add Subsection</button>
                </div>
            </div>
            
            <!-- Custom Sections -->
            <div id="custom-sections"></div>
            
            <!-- Add Custom Section Button -->
            <button id="add-section-btn" class="add-section-btn">Add New Section</button>
        </div>
        
        <!-- Hidden form for PDF generation -->
        <form id="pdf-form" action="/generate-pdf/" method="post" class="hidden">
            <input type="hidden" name="html_content" id="report-html">
            <button type="submit" id="pdf-submit-btn">Generate PDF</button>
        </form>
    </div>
    
    <script>
        // Initialize Quill editors
        const editorElements = document.querySelectorAll('.editor');
        const editors = {};
        let customEditorCounter = 0;
        
        function initializeEditor(element) {
            if (element.id) {
                editors[element.id] = new Quill(`#${element.id}`, {
                    theme: 'snow',
                    modules: {
                        toolbar: [
                            ['bold', 'italic', 'underline'],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            ['clean']
                        ]
                    }
                });
                return editors[element.id];
            }
            return null;
        }
        
        editorElements.forEach(element => {
            initializeEditor(element);
        });
        
        // Add custom field
        function addCustomField(type, containerSelector) {
            const customFieldLabel = prompt("Enter field label:", "");
            if (customFieldLabel) {
                const container = document.querySelector(containerSelector);
                const fieldId = `custom-${type}-${Date.now()}`;
                
                const newRow = document.createElement('p');
                newRow.className = 'data-row';
                newRow.innerHTML = `
                    <span class="data-label">${customFieldLabel}:</span>
                    <span id="${fieldId}" class="editor"></span>
                    <button class="remove-field-btn" title="Remove field" onclick="removeField(this.parentElement)">Ã—</button>
                `;
                
                container.appendChild(newRow);
                
                // Initialize editor for this field
                initializeEditor(newRow.querySelector('.editor'));
                
                // If in view mode, hide the toolbar
                if (document.getElementById('edit-toggle-btn').textContent === 'Enter Edit Mode') {
                    newRow.querySelector('.ql-toolbar').style.display = 'none';
                }
            }
        }
        
        // Remove field
        function removeField(element) {
            if (confirm("Are you sure you want to remove this field?")) {
                element.remove();
            }
        }
        
        // Add custom subsection
        function addCustomSubsection(sectionType) {
            const subsectionTitle = prompt("Enter subsection title:", "");
            if (subsectionTitle) {
                const container = document.getElementById(`custom-subsections-${sectionType}`);
                const subsectionId = `custom-subsection-${Date.now()}`;
                
                const newSubsection = document.createElement('div');
                newSubsection.className = 'subsection';
                newSubsection.innerHTML = `
                    <div class="subsection-title">${subsectionTitle}</div>
                    <div class="custom-fields-${subsectionId}"></div>
                    <div class="add-field-container">
                        <button class="add-field-btn" title="Add new field" onclick="addCustomField('${subsectionId}', '.custom-fields-${subsectionId}')">+</button>
                        <button class="remove-field-btn" style="position: relative; margin-left: 10px;" title="Remove subsection" onclick="removeSubsection(this.parentElement.parentElement)">Ã—</button>
                    </div>
                `;
                
                container.appendChild(newSubsection);
            }
        }
        
        // Remove subsection
        function removeSubsection(element) {
            if (confirm("Are you sure you want to remove this subsection?")) {
                element.remove();
            }
        }
        
        // Add custom section
        document.getElementById('add-section-btn').addEventListener('click', function() {
            const sectionTitle = prompt("Enter section title:", "");
            if (sectionTitle) {
                const container = document.getElementById('custom-sections');
                const sectionId = `custom-section-${Date.now()}`;
                
                const newSection = document.createElement('div');
                newSection.className = 'section';
                newSection.id = sectionId;
                newSection.innerHTML = `
                    <h2 class="section-title">${sectionTitle}</h2>
                    <div id="${sectionId}-content" class="editor"></div>
                    <div id="custom-subsections-${sectionId}"></div>
                    <div class="section-actions">
                        <button class="add-subsection-btn" onclick="addCustomSubsection('${sectionId}')">Add Subsection</button>
                        <button class="remove-field-btn" style="position: relative; margin-left: 10px;" title="Remove section" onclick="removeSection('${sectionId}')">Ã—</button>
                    </div>
                `;
                
                container.appendChild(newSection);
                
                // Initialize editor for this section
                initializeEditor(document.getElementById(`${sectionId}-content`));
                
                // If in view mode, hide the toolbar
                if (document.getElementById('edit-toggle-btn').textContent === 'Enter Edit Mode') {
                    document.querySelector(`#${sectionId}-content .ql-toolbar`).style.display = 'none';
                }
            }
        });
        
        // Remove section
        function removeSection(sectionId) {
            if (confirm("Are you sure you want to remove this section?")) {
                document.getElementById(sectionId).remove();
            }
        }
        
        // Edit mode toggle
        const editToggleBtn = document.getElementById('edit-toggle-btn');
        const editMode = true; // Start in edit mode by default
        
        editToggleBtn.addEventListener('click', function() {
            const editorContainers = document.querySelectorAll('.ql-toolbar');
            const addButtons = document.querySelectorAll('.add-field-btn, .add-subsection-btn, .add-section-btn');
            const removeButtons = document.querySelectorAll('.remove-field-btn');
            
            if (editToggleBtn.textContent === 'Exit Edit Mode') {
                // Switch to view mode
                editorContainers.forEach(toolbar => {
                    toolbar.style.display = 'none';
                });
                addButtons.forEach(btn => {
                    btn.style.display = 'none';
                });
                removeButtons.forEach(btn => {
                    btn.style.display = 'none';
                });
                editToggleBtn.textContent = 'Enter Edit Mode';
            } else {
                // Switch to edit mode
                editorContainers.forEach(toolbar => {
                    toolbar.style.display = 'block';
                });
                addButtons.forEach(btn => {
                    btn.style.display = 'inline-block';
                });
                removeButtons.forEach(btn => {
                    btn.style.display = 'block';
                });
                editToggleBtn.textContent = 'Exit Edit Mode';
            }
        });
        
        // Generate PDF
        document.getElementById('generate-pdf-btn').addEventListener('click', function() {
            // Temporarily hide toolbars and edit controls
            const editorContainers = document.querySelectorAll('.ql-toolbar');
            const addButtons = document.querySelectorAll('.add-field-btn, .add-subsection-btn, .add-section-btn');
            const removeButtons = document.querySelectorAll('.remove-field-btn');
            
            editorContainers.forEach(toolbar => {
                toolbar.style.display = 'none';
            });
            addButtons.forEach(btn => {
                btn.style.display = 'none';
            });
            removeButtons.forEach(btn => {
                btn.style.display = 'none';
            });
            
            // Clone content for PDF generation
            const content = document.getElementById('editor-container').cloneNode(true);
            
            // Clean up the content
            content.querySelectorAll('.ql-editor').forEach(editor => {
                if (editor.innerHTML.trim() === '<p><br></p>' || editor.innerHTML.trim() === '') {
                    const parentRow = editor.closest('.data-row');
                    if (parentRow) {
                        parentRow.style.display = 'none';
                    } else {
                        editor.parentElement.style.display = 'none';
                    }
                }
            });
            
            // Remove empty subsections
            content.querySelectorAll('.subsection').forEach(subsection => {
                const visibleRows = subsection.querySelectorAll('.data-row[style="display: block"], .data-row:not([style])');
                if (visibleRows.length === 0 && !subsection.querySelector('.editor:not(.ql-editor)')) {
                    subsection.style.display = 'none';
                }
            });
            
            // Remove controls from PDF content
            content.querySelectorAll('.section-actions, #add-section-btn').forEach(el => {
                el.remove();
            });
            
            // Set form values and submit
            document.getElementById('report-html').value = content.innerHTML;
            document.getElementById('pdf-form').submit();
            
            // Restore toolbars if in edit mode
            if (editToggleBtn.textContent === 'Exit Edit Mode') {
                editorContainers.forEach(toolbar => {
                    toolbar.style.display = 'block';
                });
                addButtons.forEach(btn => {
                    btn.style.display = 'inline-block';
                });
                removeButtons.forEach(btn => {
                    btn.style.display = 'block';
                });
            }
        });
        
        // Initialize the page in edit mode
        document.addEventListener('DOMContentLoaded', function() {
            // Show all edit controls initially
            const addButtons = document.querySelectorAll('.add-field-btn, .add-subsection-btn, .add-section-btn');
            addButtons.forEach(btn => {
                btn.style.display = 'inline-block';
            });
        });
    </script>
</body>
</html> 